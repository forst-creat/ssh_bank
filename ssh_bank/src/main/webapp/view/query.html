<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>查询列表页</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="../css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}" >
    <link rel="stylesheet" href="../css/bootstrap-table.css" th:href="@{/css/bootstrap-table.css}" >
    <style>

        .navbar-default {
            margin-bottom: 0px;
        }

        .middleMenu {
            z-index: 1;
            width: 100%;
            height: 50px;
            background-color: #faf9f7;
        }

        .middleMenu ul {
            margin-bottom: 0px;
            margin-left: 180px;   /* 去除外边距，使其能够紧贴<div>边缘 */
            padding: 0px;    /* 去除内边距，使其能够紧贴<div>边缘 */
            list-style: none;   /* 去除无序列表的标识符 */
        }

        .middleMenu ul li {
            float: left;
            text-align: center;
            width: 100px;
        }

        .middleMenu ul li a {
            color: #2aabd2;
        }

        .middleMenu ul li a:hover{
            text-align: center;
            width: 100px;
            background-color: #2aabd2;
            border-radius: 8px;
            color: #ffffff;
        }

        a {
            color: #999999;
            display: block; /* 转换为块级元素，为了让点击范围能够扩充到整个<li>区域 */
            line-height: 50px;  /* 设置内边距让文字垂直居中。 */
            text-decoration: none; /* 去除<a>标签的下划线 */
        }

        a:hover {
            display: block; /* 转换为块级元素，为了让点击范围能够扩充到整个<li>区域 */
            text-decoration: none; /* 去除<a>标签的下划线 */
        }

        .thirdMenu {
            margin-top: 15px;
            margin-left: 10px;
        }

        table {
            margin-left: 60px;
        }

        .word {
            padding-left: 30px;
            width: 120px;
        }

        .inner {
            width: 100px;
            height: 50px;
            margin-right: 20px;
        }

       .btnl-size {
           margin-left: 20px;
       }

        /*clearfix:after {*/
        /*    content:"";*/
        /*    display:block;*/
        /*    clear:both;*/
        /*}*/

        .btnr-size {
            margin-right: 5px;
        }

       button {
           height: 30px;
       }


    </style>
</head>
<body>
<!--第一部分：页眉部分-->
<div>
    <nav class="navbar navbar-default">
        <div class="container-fluid">

            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a>&#12288&#12288&#12288&#12288&#12288&#12288</a></li>
                    <li><a href="">签约</a></li>
                    <li><a href="">手续费</a></li>
                    <li><a href="">保证金</a></li>
                    <li><a href="">费用支付</a></li>
                    <li><a href="">投放</a></li>
                    <li><a href="">租前息</a></li>
                    <li><a href="">起租</a></li>
                    <li><a href="">调息</a></li>
                    <li><a href="">提前留购</a></li>
                    <li><a href="">变更</a></li>
                    <li><a href="">终止</a></li>
                    <li><a href="">主动扣款</a></li>
                    <li><a href="">发票</a></li>
                    <li><a href="">维修储备金</a></li>
                    <li><a href="">押金</a></li>
                </ul>
            </div>
        </div>
    </nav>
</div>

<!--第二部分-->
<div class="middleMenu">
    <ul>
        <li><a href="#">公告通知</a></li>
        <li><a href="#">我的任务</a></li>
        <li><a href="#">我的关注</a></li>
        <li><a href="#">我的实体</a></li>
        <li><a href="#">我的推荐</a></li>
        <li><a href="#">现场办公</a></li>
    </ul>
</div>

<!--第三部分-->
<div class="thirdMenu">

 <table >
     <tr>
         <td class="word">客户名称</td>
         <td class="inner">
             <input type="text" name="fullName" placeholder="请输入名称" style="border-radius: 5px"/>
         </td>
         <td class="word">业务场景</td>
         <td class="inner">
             <select id="service" style="width: 183px;height: 26px;border-radius: 5px" >
             <option>请选择 </option>
             <option>尽职调查</option>
             <option>租期检查</option>
             <option>签约现场</option>
             <option>投标现场</option>
             <option>拍卖现场</option>
             <option>其他</option>
         </select>
         </td>
         <td class="word">工作类型</td>
         <td class="inner">
             <select id="workType" style="width: 183px;height: 26px;border-radius: 5px">
             <option>请选择</option>
         </select>
         </td>
         <td class="word">&emsp;&emsp;阶段</td>
         <td class="inner">
             <select id="phase" style="width: 183px;height: 26px;border-radius: 5px">
             <option>请选择</option>
             <option>执行中</option>
             <option>已完成</option>
         </select>
         </td>
     </tr>
     <tr>
         <td class="word">负责人</td>
         <td class="inner">
             <input type="text" name="admin" placeholder="请输入名称" style="border-radius: 5px"/>
         </td>
         <td class="word">所属部门</td>
         <td class="inner">
             <input type="text" name="department" style="border-radius: 5px"/>
         </td>
     </tr>
 </table>


    <div style="margin-bottom: 50px;margin-left: 80px;margin-right: 70px">
        <div class="btn-group btnl-size" role="group" style="float: left">
            <button id="btn1" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
            </button>
            <button id="btn2" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>编辑
            </button>
            <button id="deletebtn" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>删除
            </button>
            <button type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-export" aria-hidden="true"></span>导出出差记录
            </button>
            <button type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-new-window" aria-hidden="true"></span>共享
            </button>
            <button type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-send" aria-hidden="true"></span>分派
            </button>
            <button id="exportbtn" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-export" aria-hidden="true"></span>导出
            </button>
        </div>

        <div class="btn-group btnr-size" role="group" style="float: right">
            <button id="querybtn" type="button" class="btn btn-default" >
                <span class="glyphicon glyphicon-search" aria-hidden="true"></span>查询
            </button>
            <button  id="resetbtn" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span>重置
            </button>
            <button type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-triangle-top" aria-hidden="true"></span>收起
            </button>
        </div>
    </div>

    <div style="width: 90%; margin-left: 80px " >
        <table id="bstable"></table>
    </div>



</div>

<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<script src="../js/jquery-3.5.1.min.js" th:src="@{/js/jquery-3.5.1.min.js}"></script>
<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
<script src="../js/bootstrap.min.js" th:src="@{/js/bootstrap.min.js}"></script>
<script src="../js/bootstrap-table.min.js" th:src="@{/js/bootstrap-table.min.js}"></script>
<!-- 汉化文件 after bootstrap-table.js -->
<script src="../js/bootstrap-table-zh-CN.js" th:src="@{/js/bootstrap-table-zh-CN.js}"></script>
<script src="../js/moment.min.js" th:src="@{/js/moment.min.js}"></script>
<script src="../js/tableExport.min.js" th:src="@{/js/tableExport.min.js}"></script>
<script src="../js/xlsx.js" th:src="@{/js/xlsx.js}"></script>
<script src="../js/xlsx.core.min.js" th:src="@{/js/xlsx.core.min.js}"></script>
<script src="../js/FileSaver.min.js" th:src="@{/js/FileSaver.min.js}"></script>
</body>

<script>
    $(function () {

        // $('#workType').click(function () {
        //      alert($('#service'))
        //     alert($('#workType > option').length)
        // })
        $('#service').click(function () {
            if ($('#service option:selected').val() == '尽职调查' && $('#workType > option').length < 2) {
                $("<option>项目营销</option>").appendTo($('#workType')),
                $("<option>正式调查</option>").appendTo($('#workType')),
                $("<option>权属办理</option>").appendTo($('#workType')),
                $("<option>押品办理</option>").appendTo($('#workType')),
                $("<option>其他</option>").appendTo($('#workType'))
            }else {
                $("#workType option:contains('项目营销')").remove(),
                $("#workType option:contains('正式调查')").remove(),
                $("#workType option:contains('权属办理')").remove(),
                $("#workType option:contains('押品办理')").remove(),
                $("#workType option:contains('其他')").remove()
            }
        })

        $('#btn1').click(function () {
            $(location).attr("href","add.html")
           
        })
        
     //编辑实现   
        $('#btn2').click(function () { 	
    		var id;
        	var len = $("#bstable tbody tr").length;
        	if($("tbody input[type=checkbox]:checked").length == 1) {
     			for(var i = 0;i < len;i++) {
   				 	if($("tbody input[type=checkbox]").eq(i).is(":checked")) {
   					  	 if($("tbody input[type=checkbox]").eq(i).parent().parent().parent().children().eq(7).text() == "执行中") {
   						  	id = $("tbody input[type=checkbox]").eq(i).parent().parent().next().text();
   						 	$(location).attr("href","edit?id="+id);  /* 满足要求跳转编辑页面的同时携带id参数 */
   					  	}else {
   						  alert("已完成状态的现场办公数据不可编辑!")
   					  	}  	
   					}
   				} 
        	}else if($("tbody input[type=checkbox]:checked").length == 0) {
        		alert("请选择要编辑的客户记录!")
        	}else {
        		alert("只能选中一条记录!")
        	} 	   
        })
        
        
        //bootstrap-table动态表格
        $('#bstable').bootstrapTable({
            url: '/findAllCustomer',   //请求地址
            method: "GET", //请求方式
            columns:[
            	 {field : 'checked', checkbox: true, align: 'center', valign: 'middle'},
                 {title: 'id' , field: 'cid'},
                 {title: '客户名称' , field: 'fullName',align: 'center'},
                 {title: '起始时间' , field: 'startTime',align: 'center'},
                 {title: '结束时间' , field: 'endTime',align: 'center'},
                 {title: '业务场景' , field: 'service',align: 'center'},
                 {title: '工作类型' , field: 'jobKind',align: 'center'},
                 {title: '阶段' , field: 'phase',align: 'center'},
                 {title: '负责人' , field: 'admin',align: 'center'},
                 {title: '所属部门' , field: 'department',align: 'center'},
                 {title: '创建日期' , field: 'createTime',align: 'center',formatter: formatTime},
                 {title: '目标(起因)', field: 'target',align: 'center',visible : false},
                 {title: '内容(经过)', field: 'content',align: 'center',visible : false},
                 {title: '效果(结果)', field: 'effect',align: 'center',visible : false}   
            ],
            //-----------------样式设置-------------------
            striped : true, //是否显示行间隔色
            clickToSelect: false,    //是否启用点击选中行
            cash: false,    //是否使用缓存，默认为true 
            showRefresh : true,//刷新按钮
            showFullscreen: true, //全屏显示
            showColumnsToggleAll: false, //显示所有列
            //-----------------分页-------------------
            sidePagination: 'server',  //表示在客户端分页，还是服务器分页，值为枚举类型：server、client
            pagination: true,     //默认表示false,不分页
            pageList: [5,10,15,20],//显示条数选择
            queryParams: queryParams,  //传递参数
        })
        

        //queryParams在表格查询数据之前，会先调用该方法，将该方法的返回值作为查询的参数,params是自动传过来的一个js对象
        function queryParams(params) {
        	 console.log(params); 
        	var temp = {
        		limit : params.limit,  //每个页面的记录数
        		offset : params.offset,	  //索引[偏移量] 前两者用于持久层查询sql语句的拼接
         	 	fullName : $("input[name=fullName]").val(), //客户名称
         		service : $("#service option:selected").val()=="请选择" ? '' : $("#service option:selected").val() , //业务场景
        		jobKind : $("#workType option:selected").val()=="请选择" ? '' : $("#workType option:selected").val(),  //工作类型 
        		phase : $("#phase option:selected").val()=="请选择" ? '' : $("#phase option:selected").val(),  //阶段 
        		admin : $("input[name=admin]").val(), //负责人
        		department : $("input[name=department]").val() //所属部门 
        	};
        	return temp;
        }
        
        //格式化日期，该函数在数据渲染的时候会自动调用，方法的第一参数是当前的格子的数据
        //第二个参数是整行的数据
        //格子中真正展示的内容是该方法的返回值
        function formatTime(value,rows) {
            return moment().format('YYYY-MM-DD');
        }
        
//---------------------------------------------------------------------------------------------------------------//       
        
		//执行搜索 
		$("#querybtn").on("click",function() {
			//跳转到表格第一页
			$('#bstable').bootstrapTable('selectPage',1);
		})

//----------------------------------------------------------------------------------------------------------------//		
		//重置实现
		$("#resetbtn").on("click",function () {
	          $("input[name=admin]").val('');  //负责人
	          $("input[name=fullName]").val(''); //客户名称
	          $("#service option:first").prop("selected",true);//业务场景
	          $("#workType option:first").prop("selected",true);  //工作类型
	          $("#phase option:first").prop("selected",true);  //阶段
	          $("input[name=department]").val(''); //所属部门 
			  $("#bstable").bootstrapTable('selectPage',1); //调用bootstrap-table之前queryParam中的查询参数都置空了
		})
//--------------------------------------------------------------------------------------------------------------//		
		//删除实现
		$("#deletebtn").on("click",function() {
			
			 var idList = new Array(); 
			/* alert($("#bstable tbody tr").length); */	
			/* alert($("tbody input[type=checkbox]:eq(0)").parent().parent().next().text()) */
			//注意      jquery中:eq()中的索引参数不能是变量,.eq()可以
			
/* 			var len = $("tbody input[type=checkbox]:checked").length;
			
			$("tbody input[type=checkbox]:checked")
			
			alert(len); */
			var len = $("#bstable tbody tr").length;
			var count = 0;    //用来定位选中的记录的阶段是否有已完成
			var ids = [];
 			for(var i = 0;i < len;i++) {
				 if($("tbody input[type=checkbox]").eq(i).is(":checked")) {
					  /* if($("tbody input[type=checkbox]").eq(i).parent().parent().parent().children().eq(7).text() == "执行中") {} */
					idList.push({
						"id":$("tbody input[type=checkbox]").eq(i).parent().parent().next().text(),
						"phase":$("tbody input[type=checkbox]").eq(i).parent().parent().parent().children().eq(7).text()
					});  	
				}				 
			}	
 			console.log(idList);
 			for(var i = 0; i < idList.length;i++) {
 				if(idList[i].phase == '已完成') {
 					count++;
 				}
 			} 
 			
 			if(idList.length == 0) {
 				alert("请选择要删除的记录进行删除!")
 			}else{
 	 			if(count == idList.length) {
 	 				alert("已完成状态的现场办公数据不可删除!")
 	 			}else if(count > 0 && count < idList.length) {
 	 				alert("所删记录包含已完成的办公数据，请重新选择执行中的办公数据!")
 	 			}else {
 	 				var bool = confirm("你确定要删除这些数据吗?");
 	 				for(var  i = 0;i < idList.length;i++){
 	 					ids.push(idList[i].id);
 	 				}
 	 				 if(bool) {
 				 			//删除请求
 				 			$.ajax({
 								url: "delete",
 								type: "POST",
 								data: JSON.stringify(ids),
 								success:function(data) {
 				        			if("success" == data){
 				        				$('#bstable').bootstrapTable('selectPage',1);
 				        				alert("删除成功!");
 				        			}
 				        		},
 				        		contentType:"application/json;charset=utf-8",
 								dataType: "text"
 							}) 
 					 }else {
 						 alert("取消删除!")
 					 }
 	 			}
 				
 			}			 
		})
//-----------------------------------------------------------------------------------------------------------//		
		//导出全部或者筛选出来的记录
/* 		$("#exportbtn").on("click",function() {
			if($("#bstable tbody tr").length == 0) {
				alert("没有客户记录可以导出!");
			}else {
				 $('#bstable').tableExport({
					 type:'xlsx',
					 escape:'false',
					 exportDataType: 'selected',
					 ignoreColumn: [0,1],  //忽略某一列的索引
					 fileName: '导出客户数据表',  //文件名称设置
					 worksheetName: '客户信息记录表',
				 });
			}

		}) */
		
		$("#exportbtn").click(function() {
/* 			var ids = [];
			var len = $("#bstable tbody tr").length;
			var bool = confirm("是否要导出客户记录?");
			for(var i = 0;i < len;i++) {
				if($("tbody input[type=checkbox]").eq(i).is(":checked")) {
					ids.push($("tbody input[type=checkbox]").eq(i).parent().parent().next().text());
				}
			}
			if(bool) {
				$.ajax({
					url: "export",
					type: "POST",
					data: JSON.stringify(ids),
					success: function(data) {
						if("success" == data) {
							alert("导出成功!");
						}
					},
					contentType: "application/json;charset=utf-8",
					dataType: "text"
				})
			} */
			$(location).attr("href","export");
		})		
    })
</script>
</html>